<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta http-equiv="Cache-Control" content="no-siteapp">
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=1, minimum-scale=1, maximum-scale=1">
<meta name="renderer" content="webkit">
<meta name="google" value="notranslate">
<meta name="robots" content="index,follow">


<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="潘瑞峰的个人博客">
<meta name="twitter:description" content="走走停停看看写写">
<meta name="twitter:image:src" content="http://www.panruifeng.com/blog/blog/images/avatar.jpeg">

<meta property="og:url" content="http://www.panruifeng.com/blog">
<meta property="og:title" content="潘瑞峰的个人博客">
<meta property="og:description" content="走走停停看看写写">
<meta property="og:site_name" content="潘瑞峰的个人博客">
<meta property="og:image" content="http://www.panruifeng.com/blog/blog/images/avatar.jpeg">
<meta property="og:type" content="website">
<meta name="robots" content="noodp">

<meta itemprop="name" content="潘瑞峰的个人博客">
<meta itemprop="description" content="走走停停看看写写">
<meta itemprop="image" content="http://www.panruifeng.com/blog/blog/images/avatar.jpeg">

<link rel="canonical" href="http://www.panruifeng.com/blog">

<link rel="shortcut icon" href="/blog/favicon.png">
<link rel="apple-itouch-icon" href="/blog/favicon.png">
<link rel="stylesheet" href="/blog/bundle/index.css">
<script type="text/javascript">
    var timeSinceLang = {
        year: '年前',
        month: '个月前',
        day: '天前',
        hour: '小时前',
        minute: '分钟前',
        second: '秒前'
    };
    var root = '\/blog';
</script>


        <meta name="keywords" content="java,JNI,">
        <meta name="description" content="Java JNI">
        <meta name="author" content="潘瑞峰">
        <title>Java JNI</title>
    </head>
    <body>
        <article class="container">
            <header class="header-wrap">
  <a class="index" href="/blog/">
    <img class="logo" src="/blog/images/avatar.jpeg" />
    潘瑞峰的个人博客
  </a>
  <ul class="menu">
      <li class="menu-item"><a href="/blog/archive.html">归档</a></li>
      <li class="menu-item"><a href="/blog/tag.html">标签</a></li>
      <li class="menu-item"><a href="/blog/about.me.html">作者</a></li>
      <li class="menu-item"><a href="/blog/atom.xml">订阅</a></li>
  </ul>
</header>

            <article class="main article">
                <h1 class="title">Java JNI</h1>
                <section class="info">
                    <span class="avatar" style="background-image: url(/blog/images/avatar.jpeg);"></span>
                    <a class="name" href="/blog/about.me.html">潘瑞峰</a>
                    
                    <span class="date" data-time="1509001200"><span class="from"></span></span>
                    
                    <span class="tags"><a class="tag" href="/blog/tag/java/index.html">java</a><a class="tag" href="/blog/tag/JNI/index.html">JNI</a></span>
                </section>
                <article class="content"><h2>JNI</h2>

<p>JNI是Java Native Interface的简称，它可以调用其他语言编写的程序，主要是C和C++，具体的介绍网上有很多，就不再重复了</p>

<p>我以前都是通过协议接口，HTTP、Socket等方式，实现Java调用其他程序的(松耦合、程序之间只关注接口格式)，所以从来没用过JNI</p>

<h2>JNI Java部分代码</h2>

<pre><code class="language-Java">import java.lang.reflect.Field;
public class Main {
    
    //declare native method
    public native int add(int a, int b);

    static {
        try {
            //set native c++ lib path
            System.setProperty(&quot;java.library.path&quot;, System.getProperty(&quot;java.library.path&quot;) + &quot;:/Users/dapan/Desktop/JniTest/jnilib&quot;);
            Field fieldSysPath = ClassLoader.class.getDeclaredField(&quot;sys_paths&quot;);
            fieldSysPath.setAccessible(true);
            fieldSysPath.set(null, null);
            
            //set native c++ lib
            System.loadLibrary(&quot;JNIADD&quot;);
        } catch(Exception e) {
            //print Error
            e.printStackTrace();
        }
        
    }
    public static void main(String[] args) {
        
        Main main = new Main();
        int c = main.add(2, 3);
        System.out.println(c);
    }
}
</code></pre>

<p>可以看出，我申明了一个native方法add，但是没有实现它。然后我设置了native C++库的路径，并且载入lib-&gt;JNIADD</p>

<p>在主函数中，我调用的add函数</p>

<p>之后，可以先编译函数<code>javac Main.java</code>，在编译时，我还没实现add函数</p>

<h1>生成JNI的头文件，并且实现</h1>

<p>执行<code>javah Main</code>后，会生成Main.h文件</p>

<pre><code>/* DO NOT EDIT THIS FILE - it is machine generated */
#include &lt;jni.h&gt;
/* Header for class Main */

#ifndef _Included_Main
#define _Included_Main
#ifdef __cplusplus
extern &quot;C&quot; {
#endif
/*
 * Class:     Main
 * Method:    add
 * Signature: (II)I
 */
JNIEXPORT jint JNICALL Java_Main_add
  (JNIEnv *, jobject, jint, jint);

#ifdef __cplusplus
}
#endif
#endif
</code></pre>

<p>这个头文件就是Java调用C++的接口，所以需要实现这个头文件，因此我新建了一个Main.cpp的文件</p>

<pre><code>#include &quot;Main.h&quot;

JNIEXPORT jint JNICALL Java_Main_add
  (JNIEnv *env, jobject obj, jint a, jint b) 
  {
    return a + b ;
  }
</code></pre>

<h1>编译C++文件，并且打包成lib(mac版)</h1>

<ul>
<li>编译cpp文件： <code>g++ -I $JAVA_HOME/include -c Main.cpp</code>，编译完成后会生成Main.o文件</li>
<li>需要将Main.o打包成jnilib文件： <code>g++ -dynamiclib -o libJNIADD.jnilib Main.o</code> 打包的jnilib命名规范是libxxx.jnilib，其中xxx是我在Java中<code>System.loadLibrary(&quot;JNIADD&quot;)</code>设置的library的名称</li>
<li>最后将打包的jnilib放到Java中设置的<code>java.library.path</code>目录之一即可</li>
</ul>

<h1>结果</h1>

<p>最后就可以用<code>java Main</code>运行java程序了</p>

<p>以C++为例，在运行过程中，可以随时重新编写打包C++程序，使得程序变得很灵活；但是其可移植性会变差，因为对于不同的平台，需要重新编译C++文件。</p>
</article>
                <section class="author">
                <div class="intro">
                    <div class="ds-thread" data-thread-key="1509001200" data-title="Java JNI" data-url="http://www.panruifeng.com/blog/java_jni.html"></div>
                   


                </div>
                </section>
                <section class="author">
                    <div class="avatar" style="background-image: url(/blog/images/avatar.jpeg);"></div>
                    <a class="name" href="/blog/about.me.html">潘瑞峰</a>
                    <div class="intro">五花马，千金裘，呼儿将出换美酒，与尔同销万古愁。</div>
                </section>
                <section class="recommend">
                    
                    <section class="nav prev more">
                        <div class="head">上篇文章</div>
                        <a class="link" href="/blog/spring-redis.html">Spring中使用Redis缓存</a>
                    </section>
                    
                    
                    <section class="nav next more">
                        <div class="head">下篇文章</div>
                        <a class="link" href="/blog/mysql-full-text.html">mysql全文索引</a>
                    </section>
                    
                </section>
                
  


            </article>
        </article>
        <footer class="footer">
    <span class="copyright">
        潘瑞峰的个人博客 ©
        <script type="text/javascript">
            document.write(new Date().getFullYear());
        </script>
    </span>
    <span class="publish">Powered by <a href="http://www.chole.io/" target="_blank">Ink</a></span>
</footer>

        <script src="/blog/bundle/index.js"></script>
    </body>
</html>
